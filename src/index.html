<!DOCTYPE html>
<html>

<head>
    <title>QUBeditotron3000</title>

    <script type="text/javascript">

        let wordcountURL = "http://wordcount.editor.qpc.qubcloud.uk";
        let charcountURL = "http://charcount.editor.qpc.qubcloud.uk";
      
        // Local URL for the microservices (these get set after config.json loads)
        let vowelcountURL, avgwordURL, puncCountURL, longestwordURL;

        // disable all the buttons until config.json is ready
        function setButtonsEnabled(enabled) {
          const ids = ["WordcountBtn","CharcountBtn","AvgBtn","PuncBtn","LongestBtn","VowelBtn"];
          ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.disabled = !enabled;
          });
        }
        setButtonsEnabled(false);

        // load the urls from config.json
        fetch("config.json")
          .then(response => response.json())
          .then(config => {
             vowelcountURL  = config.vowelcountURL;
             avgwordURL     = config.avgwordURL;
             puncCountURL   = config.puncCountURL;
             longestwordURL = config.longestwordURL;
             setButtonsEnabled(true); // enable buttons once urls are set
          })
          .catch(err => {
            document.getElementById('output').value = "Config failed to load";
            console.error(err);
          });

        // helper so functions dont run before urls are ready
        function ensure(url, name) {
          if (!url) {
            document.getElementById('output').value = name + " URL not ready (config)";
            return false;
          }
          return true;
        }

        // --- STATEFUL SAVING FEATURE ---
        // restore saved text into the textarea when the page loads
        window.onload = function() {
            const savedText = localStorage.getItem("editorContent");
            if (savedText) {
                document.getElementById("content").value = savedText;
            }
        };

        // every time the user types, save the text into localStorage
        function saveState() {
            const currentText = document.getElementById("content").value;
            localStorage.setItem("editorContent", currentText);
        }
        // attach event listener for typing into textarea
        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById("content").addEventListener("input", saveState);
        });
        // --------------------------------

        function Wordcount() {
            if (!ensure(wordcountURL, "Wordcount")) return;
            let xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var j = JSON.parse(this.response);
                    document.getElementById('output').value = j.answer;
                }
            };
            let url = wordcountURL + "/?text=" + encodeURI(document.getElementById('content').value);
            xhttp.open("GET", url);
            xhttp.send();
        }

        function Charcount() {
            if (!ensure(charcountURL, "Charcount")) return;
            let xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var j = JSON.parse(this.response);
                    document.getElementById('output').value = j.answer;
                }
            };
            let url = charcountURL + "/?text=" + encodeURI(document.getElementById('content').value);
            xhttp.open("GET", url);
            xhttp.send();
        }

        // Function to count the number of vowels in the input text
        function Vowelcount() {
            if (!ensure(vowelcountURL, "Vowelcount")) return;
            let xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4) {
                    try {
                        var j = JSON.parse(this.response);
                        if (this.status == 200) {
                            document.getElementById('output').value = j.description;
                        } else {
                            document.getElementById('output').value = j.error || "Service error";
                        }
                    } catch (e) {
                        document.getElementById('output').value = "Unexpected error";
                    }
                }
            };
            let url = vowelcountURL + "/?text=" + encodeURI(document.getElementById('content').value);
            xhttp.open("GET", url);
            xhttp.send();
        }

        // Function that sends a GET request to the avg word length service I made
        function AvgWordLength() {
            if (!ensure(avgwordURL, "AvgWordLength")) return;
            let xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var j = JSON.parse(this.response);
                    document.getElementById('output').value = j.result;
                }
            };
            let url = avgwordURL + "/?text=" + encodeURI(document.getElementById('content').value);
            xhttp.open("GET", url);
            xhttp.send();
        }

        // Function that sends a GET request to the punctuation count service I made
        function PuncCount() {
            if (!ensure(puncCountURL, "PuncCount")) return;
            let xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var j = JSON.parse(this.response);
                    document.getElementById('output').value = j.result;
                }
            };
            let url = puncCountURL + "/?text=" + encodeURI(document.getElementById('content').value);
            xhttp.open("GET", url);
            xhttp.send();
        }

        // Function that sends a GET request to the longest word service I made
        function LongestWord() {
            if (!ensure(longestwordURL, "LongestWord")) return;
            let xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4) {
                    try {
                        var j = JSON.parse(this.response);
                        if (this.status == 200) {
                            document.getElementById('output').value = j.result;
                        } else {
                            document.getElementById('output').value = j.error || "Service unavailable";
                        }
                    } catch (e) {
                        document.getElementById('output').value = "Unexpected error";
                    }
                }
            };
            let url = longestwordURL + "/?text=" + encodeURI(document.getElementById('content').value);
            xhttp.open("GET", url);
            xhttp.send();
        }

    </script>

    <style type="text/css">
        body {
            font-size: 150%;
            font-family: monospace;
        }

        #logo {
            font-family: Calibri, sans-serif;
            font-weight: lighter;
            color: #505050;
            margin: 0.5em;
        }

        #editor {
            text-align: center;
            margin-top: 1em;
        }

        #output {
            font-size: 100%;
            padding: 0.2em;
            margin: 0.2em;
            font-family: monospace;
            letter-spacing: 0.1em;
        }

        #content {
            font-size: 100%;
            padding: 0.2em;
            margin: 0.2em;
            font-family: monospace;
            letter-spacing: 0.1em;
        }

        .operation {
            border: solid #d0d0d0 1px;
            background-color: #f0f0f0;
            padding: 1.5em;
            margin: 1em;
            width: 14em;
        }
    </style>

</head>

<body>
    <div id="editor">
        <div id="logo">
            QUBeditotron3000
        </div>
        <div>
            <textarea rows="5" cols="40" id="content">It was the best of cloud, it was the worst of cloud...</textarea>
        </div>
        <div>
            <input type="text" id="output" readonly="1" value="" />
        </div>
        <div>
          <button id="WordcountBtn" class="operation" onclick="Wordcount();" disabled>Word Count</button>
          <button id="CharcountBtn" class="operation" onclick="Charcount();" disabled>Character Count</button>
          <button id="AvgBtn"       class="operation" onclick="AvgWordLength();" disabled>Avg Word Length</button>
          <button id="PuncBtn"      class="operation" onclick="PuncCount();" disabled>Punctuation Count</button>
          <button id="LongestBtn"   class="operation" onclick="LongestWord();" disabled>Longest Word</button>
          <button id="VowelBtn"     class="operation" onclick="Vowelcount();" disabled>Vowel Count</button>
        </div>
    </div>
</body>

</html>
